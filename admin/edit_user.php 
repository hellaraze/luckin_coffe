

<?php
session_start();
require_once __DIR__ . '/../includes/db.php';

// Проверка авторизации: только администратор
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'admin') {
    header('Location: ../login.php');
    exit;
}

// Получение ID пользователя
if (!isset($_GET['id'])) {
    header('Location: users.php');
    exit;
}
$userId = (int)$_GET['id'];

// Обработка формы
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $name   = trim($_POST['name'] ?? '');
    $login  = trim($_POST['login'] ?? '');
    $roleId = (int)($_POST['role_id'] ?? 2);
    $password = $_POST['password'] ?? '';

    if ($name && $login) {
        if ($password !== '') {
            // Обновляем пароль, если задан
            $hashedPassword = password_hash($password, PASSWORD_DEFAULT);
            $stmt = $conn->prepare("
                UPDATE users 
                SET name = ?, login = ?, password = ?, role_id = ?
                WHERE id = ?
            ");
            $stmt->bind_param("sssii", $name, $login, $hashedPassword, $roleId, $userId);
        } else {
            // Без изменения пароля
            $stmt = $conn->prepare("
                UPDATE users 
                SET name = ?, login = ?, role_id = ?
                WHERE id = ?
            ");
            $stmt->bind_param("ssii", $name, $login, $roleId, $userId);
        }
        $stmt->execute();
        header('Location: users.php');
        exit;
    } else {
        $error = 'Имя и логин обязательны.';
    }
}

// Получение данных пользователя
$stmt = $conn->prepare("SELECT name, login, role_id, active FROM users WHERE id = ?");
$stmt->bind_param("i", $userId);
$stmt->execute();
$result = $stmt->get_result();
if ($result->num_rows === 0) {
    header('Location: users.php');
    exit;
}
$user = $result->fetch_assoc();

// Получение списка ролей
$roles = [];
$res = $conn->query("SELECT id, name FROM roles");
while ($row = $res->fetch_assoc()) {
    $roles[] = $row;
}
?>
<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Редактировать пользователя</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
  <h2>Редактировать пользователя</h2>
  <?php if (!empty($error)): ?>
    <div class="alert alert-danger"><?= htmlspecialchars($error) ?></div>
  <?php endif; ?>
  <form method="post">
    <div class="mb-3">
      <label class="form-label">Имя</label>
      <input type="text" name="name" class="form-control" required value="<?= htmlspecialchars($user['name']) ?>">
    </div>
    <div class="mb-3">
      <label class="form-label">Логин</label>
      <input type="text" name="login" class="form-control" required value="<?= htmlspecialchars($user['login']) ?>">
    </div>
    <div class="mb-3">
      <label class="form-label">Новый пароль (оставьте пустым, чтобы не менять)</label>
      <input type="password" name="password" class="form-control">
    </div>
    <div class="mb-3">
      <label class="form-label">Роль</label>
      <select name="role_id" class="form-select">
        <?php foreach ($roles as $r): ?>
          <option value="<?= $r['id'] ?>" <?= $user['role_id'] == $r['id'] ? 'selected' : '' ?>>
            <?= htmlspecialchars($r['name']) ?>
          </option>
        <?php endforeach; ?>
      </select>
    </div>
    <button type="submit" class="btn btn-primary">Сохранить</button>
    <a href="users.php" class="btn btn-secondary">Отмена</a>
  </form>
</div>
</body>
</html>